class Dimensions {
  double? weight;
  double? height;
  double? width;
  double? length;

  Dimensions({this.weight, required this.height, required this.width, required this.length});

  Map<String, dynamic> toMap() {
    return {'weight': weight, 'height': height, 'width': width, 'length': length};
  }

  static Dimensions? fromMap(Map<String, dynamic>? map) {
    Dimensions? dimensions;

    if (map == null || map.isEmpty || map['documentId'] == null) {
      dimensions = Dimensions(height: null, width: null, length: null);
    } else {
      dimensions = Dimensions(
        weight: map.containsKey('weight') ? map['weight'] : null,
        height: map.containsKey('height') ? map['height'] : null,
        width: map.containsKey('width') ? map['width'] : null,
        length: map.containsKey('length') ? map['length'] : null,
      );
    }

    return dimensions;
  }

  static Map<String, Dimensions?> populate(Map<String, dynamic> map) {
    Map<String, Dimensions?> innerMap;

    innerMap = <String, Dimensions?>{};

    for (var key in map.keys) {
      innerMap[key] = Dimensions.fromMap(map[key]);
    }

    return innerMap;
  }
}

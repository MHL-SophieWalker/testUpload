import 'package:hart_suite/models/area/area.dart';
import 'package:hart_suite/models/data/data_point.dart';
import 'package:hart_suite/models/equipment/classification.dart';
import 'package:hart_suite/models/equipment/dimensions.dart';
import 'package:hart_suite/models/equipment/equipment_status.dart';
import 'package:hart_suite/models/equipment/equipment_subcategory.dart';
import 'package:hart_suite/models/equipment/equipment_type.dart';
import 'package:hart_suite/models/general/auditable.dart';
import 'package:hart_suite/models/tag/tag.dart';

class Equipment {
  String? documentId;
  String name;
  String description;
  Map<String, Area?> area;
  Dimensions dimensions;
  String manufacturer;
  String model;
  String partNumber;
  String serialNumber;
  DateTime nextInspectionDate;
  DateTime warrantyEndDate;
  Map<String, EquipmentStatus?> status;
  Map<String, EquipmentSubcategory?> subcategory;
  Map<String, EquipmentType?> type;
  Map<String, Classification?> classifications;
  Map<String, Tag?> tags;
  Map<String, DataPoint?> dataPoints;
  Auditable? created;
  Auditable? updated;
  Auditable? deleted;

  Equipment(
      {this.documentId,
      required this.name,
      required this.description,
      required this.area,
      required this.dimensions,
      required this.manufacturer,
      required this.model,
      required this.partNumber,
      required this.serialNumber,
      required this.nextInspectionDate,
      required this.warrantyEndDate,
      required this.status,
      required this.subcategory,
      required this.type,
      required this.classifications,
      required this.tags,
      required this.dataPoints,
      this.created,
      this.updated,
      this.deleted});

  Map<String, dynamic> toMap() {
    return {
      'documentId': documentId,
      'name': name,
      'description': description,
      'area': area.map((key, value) => MapEntry(key, value?.toMap())),
      'dimensions': dimensions.toMap(),
      'manufacturer': manufacturer,
      'model': model,
      'partNumber': partNumber,
      'serialNumber': serialNumber,
      'nextInspectionDate': nextInspectionDate,
      'warrantyEndDate': warrantyEndDate,
      'status': status.map((key, value) => MapEntry(key, value?.toMap())),
      'subcategory': subcategory.map((key, value) => MapEntry(key, value?.toMap())),
      'type': type.map((key, value) => MapEntry(key, value?.toMap())),
      'classifications': classifications.map((key, value) => MapEntry(key, value?.toMap())),
      'tags': tags.map((key, value) => MapEntry(key, value?.toMap())),
      'dataPoints': dataPoints.map((key, value) => MapEntry(key, value?.toMap())),
      'created': created?.toMap(),
      'updated': updated?.toMap(),
      'deleted': deleted?.toMap()
    };
  }

  static Equipment? fromMap(Map<String, dynamic>? map) {
    Equipment? equipment;
    Map<String, Area?> areaMap = {};
    Map<String, EquipmentStatus?> statusMap = {};
    Map<String, EquipmentSubcategory?> subcategoryMap = {};
    Map<String, EquipmentType?> typeMap = {};
    Map<String, Classification?> classificationMap = {};
    Map<String, Tag?> tagMap = {};
    Map<String, DataPoint?> dataPointMap = {};

    if (map == null || map.isEmpty || map['documentId'] == null) {
      equipment = null;
    } else {
      if (map.containsKey('area') && map['area'] != null) {
        for (var key in map['area'].keys) {
          areaMap[key] = Area.fromMap(map['area'][key]);
        }
      }

      if (map.containsKey('dimensions') && map['dimensions'] != null) {
        for (var key in map['status'].keys) {
          statusMap[key] = EquipmentStatus.fromMap(map['status'][key]);
        }
      }

      if (map.containsKey('subcategory') && map['subcategory'] != null) {
        for (var key in map['subcategory'].keys) {
          subcategoryMap[key] = EquipmentSubcategory.fromMap(map['subcategory'][key]);
        }
      }

      if (map.containsKey('type') && map['type'] != null) {
        for (var key in map['type'].keys) {
          typeMap[key] = EquipmentType.fromMap(map['type'][key]);
        }
      }

      if (map.containsKey('classifications') && map['classifications'] != null) {
        for (var key in map['classifications'].keys) {
          classificationMap[key] = Classification.fromMap(map['classifications'][key]);
        }
      }

      if (map.containsKey('tags') && map['tags'] != null) {
        for (var key in map['tags'].keys) {
          tagMap[key] = Tag.fromMap(map['tags'][key]);
        }
      }

      if (map.containsKey('dataPoints') && map['dataPoints'] != null) {
        for (var key in map['dataPoints'].keys) {
          dataPointMap[key] = DataPoint.fromMap(map['dataPoints'][key]);
        }
      }

      equipment = Equipment(
        documentId: map.containsKey('documentId') ? map['documentId'] : null,
        name: map.containsKey('name') ? map['name'] : '',
        description: map.containsKey('description') ? map['description'] : '',
        area: areaMap,
        dimensions: map.containsKey('dimensions') ? map['dimensions'] : Dimensions(height: null, width: null, length: null),
        manufacturer: map.containsKey('manufacturer') ? map['manufacturer'] : '',
        model: map.containsKey('model') ? map['model'] : '',
        partNumber: map.containsKey('partNumber') ? map['partNumber'] : '',
        serialNumber: map.containsKey('serialNumber') ? map['serialNumber'] : '',
        nextInspectionDate: map.containsKey('nextInspectionDate') ? map['nextInspectionDate'] : DateTime.now(),
        warrantyEndDate: map.containsKey('warrantyEndDate') ? map['warrantyEndDate'] : DateTime.now(),
        status: statusMap,
        subcategory: subcategoryMap,
        type: typeMap,
        classifications: classificationMap,
        tags: tagMap,
        dataPoints: dataPointMap,
        created: map.containsKey('created') ? Auditable.fromMap(map['created']) : null,
        updated: map.containsKey('updated') ? Auditable.fromMap(map['updated']) : null,
        deleted: map.containsKey('deleted') ? Auditable.fromMap(map['deleted']) : null,
      );
    }

    return equipment;
  }

  static Map<String, Equipment?> populate(Map<String, dynamic> map) {
    Map<String, Equipment?> innerMap;

    innerMap = <String, Equipment?>{};

    for (var key in map.keys) {
      innerMap[key] = Equipment.fromMap(map[key]);
    }

    return innerMap;
  }
}

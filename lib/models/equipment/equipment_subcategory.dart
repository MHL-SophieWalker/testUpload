import 'package:hart_suite/models/equipment/equipment_category.dart';
import 'package:hart_suite/models/general/auditable.dart';

class EquipmentSubcategory {
  String? documentId;
  String name;
  Map<String, EquipmentCategory?> equipmentCategory;
  Auditable? created;
  Auditable? updated;
  Auditable? deleted;

  EquipmentSubcategory({this.documentId, required this.name, required this.equipmentCategory, this.created, this.updated, this.deleted});

  Map<String, dynamic> toMap() {
    return {
      'documentId': documentId,
      'name': name,
      'equipmentCategory': equipmentCategory.map((key, value) => MapEntry(key, value?.toMap())),
      'created': created?.toMap(),
      'updated': updated?.toMap(),
      'deleted': deleted?.toMap()
    };
  }

  static EquipmentSubcategory? fromMap(Map<String, dynamic>? map) {
    EquipmentSubcategory? equipmentSubcategory;
    Map<String, EquipmentCategory?> equipmentCategoryMap = {};

    if (map == null || map.isEmpty || map['documentId'] == null) {
      equipmentSubcategory = null;
    } else {
      if (map.containsKey('equipmentCategory') && map['equipmentCategory'] != null) {
        for (var key in map['equipmentCategory'].keys) {
          equipmentCategoryMap[key] = EquipmentCategory.fromMap(map['equipmentCategory'][key]);
        }
      }

      equipmentSubcategory = EquipmentSubcategory(
        documentId: map.containsKey('documentId') ? map['documentId'] : null,
        name: map.containsKey('name') ? map['name'] : '',
        equipmentCategory: equipmentCategoryMap,
        created: map.containsKey('created') ? Auditable.fromMap(map['created']) : null,
        updated: map.containsKey('updated') ? Auditable.fromMap(map['updated']) : null,
        deleted: map.containsKey('deleted') ? Auditable.fromMap(map['deleted']) : null,
      );
    }

    return equipmentSubcategory;
  }

  static Map<String, EquipmentSubcategory?> populate(Map<String, dynamic> map) {
    Map<String, EquipmentSubcategory?> innerMap;

    innerMap = <String, EquipmentSubcategory?>{};

    for (var key in map.keys) {
      innerMap[key] = EquipmentSubcategory.fromMap(map[key]);
    }

    return innerMap;
  }
}

import 'package:hart_suite/enums/comment_type.dart';
import 'package:hart_suite/models/app/app.dart';
import 'package:hart_suite/models/attachment/attachment.dart';
import 'package:hart_suite/models/general/auditable.dart';

class Comment {
  String? documentId;
  Map<String, App?>? app;
  String content;
  Map<String, Attachment?>? attachments;
  Auditable? created;
  Auditable? updated;
  Auditable? deleted;
  CommentType type;

  Comment({
    this.documentId,
    this.app,
    required this.content,
    this.attachments,
    this.created,
    this.updated,
    this.deleted,
    required this.type,
  });

  Map<String, dynamic> toMap() {
    return {
      'documentId': documentId,
      'app': app?.map((key, value) => MapEntry(key, value?.toMap())),
      'content': content,
      'attachments': attachments?.map((key, value) => MapEntry(key, value?.toMap())),
      'created': created?.toMap(),
      'updated': updated?.toMap(),
      'deleted': deleted?.toMap(),
      'type': type.name,
    };
  }

  static Comment? fromMap(Map<String, dynamic>? map) {
    Comment? comment;
    Map<String, App?> appMap = {};
    Map<String, Attachment?> attachmentMap = {};

    if (map == null || map.isEmpty) {
      comment = null;
    } else {
      if (map.containsKey('app') && map['app'] != null) {
        for (var key in map['app'].keys) {
          appMap[key] = App.fromMap(map['app'][key]);
        }
      }

      if (map.containsKey('attachments') && map['attachments'] != null) {
        for (var key in map['attachments'].keys) {
          attachmentMap[key] = Attachment.fromMap(map['attachments'][key]);
        }
      }

      comment = Comment(
        documentId: map.containsKey('documentId') ? map['documentId'] : null,
        app: appMap,
        content: map.containsKey('content') ? map['content'] : '',
        attachments: attachmentMap,
        created: map.containsKey('created') ? Auditable.fromMap(map['created']) : null,
        updated: map.containsKey('updated') ? Auditable.fromMap(map['updated']) : null,
        deleted: map.containsKey('deleted') ? Auditable.fromMap(map['deleted']) : null,
        type: map.containsKey('type') ? CommentType.values.firstWhere((e) => e.name == map['type']) : CommentType.general,
      );
    }

    return comment;
  }

  static Map<String, Comment?> populate(Map<String, dynamic> map) {
    Map<String, Comment?> innerMap;

    innerMap = <String, Comment?>{};

    for (var key in map.keys) {
      innerMap[key] = Comment.fromMap(map[key]);
    }

    return innerMap;
  }
}

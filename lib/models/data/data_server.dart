import 'package:hart_suite/models/data/data_server_type.dart';
import 'package:hart_suite/models/general/auditable.dart';

class DataServer {
  String? documentId;
  String name;
  String connectionString;
  Map<String, DataServerType?> dataServerType;
  Auditable? created;
  Auditable? updated;
  Auditable? deleted;

  DataServer({this.documentId, required this.name, required this.connectionString, required this.dataServerType, this.created, this.updated, this.deleted});

  Map<String, dynamic> toMap() {
    return {
      'documentId': documentId,
      'name': name,
      'connectionString': connectionString,
      'dataServerType': dataServerType.map((key, value) => MapEntry(key, value?.toMap())),
      'created': created?.toMap(),
      'updated': updated?.toMap(),
      'deleted': deleted?.toMap()
    };
  }

  static DataServer? fromMap(Map<String, dynamic>? map) {
    DataServer? dataServer;
    Map<String, DataServerType?> dataServerTypeMap = {};

    if (map == null || map.isEmpty || map['documentId'] == null) {
      dataServer = null;
    } else {
      if (map.containsKey('dataServerType') && map['dataServerType'] != null) {
        for (var key in map['dataServerType'].keys) {
          dataServerTypeMap[key] = DataServerType.fromMap(map['dataServerType'][key]);
        }
      }

      dataServer = DataServer(
        documentId: map.containsKey('documentId') ? map['documentId'] : null,
        name: map.containsKey('name') ? map['name'] : '',
        connectionString: map.containsKey('connectionString') ? map['connectionString'] : '',
        dataServerType: dataServerTypeMap,
        created: map.containsKey('created') ? Auditable.fromMap(map['created']) : null,
        updated: map.containsKey('updated') ? Auditable.fromMap(map['updated']) : null,
        deleted: map.containsKey('deleted') ? Auditable.fromMap(map['deleted']) : null,
      );
    }

    return dataServer;
  }

  static Map<String, DataServer?> populate(Map<String, dynamic> map) {
    Map<String, DataServer?> innerMap;

    innerMap = <String, DataServer?>{};

    for (var key in map.keys) {
      innerMap[key] = DataServer.fromMap(map[key]);
    }

    return innerMap;
  }
}

import 'package:hart_suite/models/app/app.dart';
import 'package:hart_suite/models/general/auditable.dart';
import 'package:hart_suite/models/profile/profile.dart';

class ChangeLog {
  String? documentId;
  Map<String, App?> app;
  String changedDocumentId;
  Map<String, Profile?> profile;
  String changeTarget;
  String changeField;
  DateTime changeOn;
  String valueFrom;
  String valueTo;
  String message;
  Auditable? created;
  Auditable? updated;
  Auditable? deleted;

  ChangeLog(
      {this.documentId,
      required this.app,
      required this.changedDocumentId,
      required this.profile,
      required this.changeTarget,
      required this.changeField,
      required this.changeOn,
      required this.valueFrom,
      required this.valueTo,
      required this.message,
      this.created,
      this.updated,
      this.deleted});

  Map<String, dynamic> toMap() {
    return {
      'documentId': documentId,
      'app': app.map((key, value) => MapEntry(key, value?.toMap())),
      'changedDocumentId': changedDocumentId,
      'profile': profile.map((key, value) => MapEntry(key, value?.toMap())),
      'changeTarget': changeTarget,
      'changeField': changeField,
      'changeOn': changeOn,
      'valueFrom': valueFrom,
      'valueTo': valueTo,
      'message': message,
      'created': created?.toMap(),
      'updated': updated?.toMap(),
      'deleted': deleted?.toMap()
    };
  }

  static ChangeLog? fromMap(Map<String, dynamic>? map) {
    ChangeLog? changeLog;
    Map<String, App?> appMap = {};
    Map<String, Profile?> profileMap = {};

    if (map == null || map.isEmpty || map['documentId'] == null) {
      changeLog = null;
    } else {
      if (map.containsKey('app') && map['app'] != null) {
        for (var key in map['app'].keys) {
          appMap[key] = App.fromMap(map['app'][key]);
        }
      }

      if (map.containsKey('profile') && map['profile'] != null) {
        for (var key in map['profile'].keys) {
          profileMap[key] = Profile.fromMap(map['profile'][key]);
        }
      }

      changeLog = ChangeLog(
        documentId: map.containsKey('documentId') ? map['documentId'] : null,
        app: appMap,
        changedDocumentId: map.containsKey('changedDocumentId') ? map['changedDocumentId'] : '',
        profile: profileMap,
        changeTarget: map.containsKey('changeTarget') ? map['changeTarget'] : '',
        changeField: map.containsKey('changeField') ? map['changeField'] : '',
        changeOn: map.containsKey('changeOn') ? map['changeOn'] : DateTime.now(),
        valueFrom: map.containsKey('valueFrom') ? map['valueFrom'] : '',
        valueTo: map.containsKey('valueTo') ? map['valueTo'] : '',
        message: map.containsKey('message') ? map['message'] : '',
        created: map.containsKey('created') ? Auditable.fromMap(map['created']) : null,
        updated: map.containsKey('updated') ? Auditable.fromMap(map['updated']) : null,
        deleted: map.containsKey('deleted') ? Auditable.fromMap(map['deleted']) : null,
      );
    }

    return changeLog;
  }

  static Map<String, ChangeLog?> populate(Map<String, dynamic> map) {
    Map<String, ChangeLog?> innerMap;

    innerMap = <String, ChangeLog?>{};

    for (var key in map.keys) {
      innerMap[key] = ChangeLog.fromMap(map[key]);
    }

    return innerMap;
  }
}

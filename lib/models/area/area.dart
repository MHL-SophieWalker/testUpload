import 'package:hart_suite/models/area/area_snapshot.dart';
import 'package:hart_suite/models/area/coords.dart';
import 'package:hart_suite/models/calendar/calendar.dart';
import 'package:hart_suite/models/general/auditable.dart';
import 'package:hart_suite/models/profile/team.dart';

class Area {
  String? documentId;
  String name;
  String description;
  String? path;
  String customer;
  Map<String, Area?>? parent;
  late String nameLower;

  Map<String, Calendar?>? calendars;
  Map<String, Team?>? teams;
  List<Coords>? geoFence;

  Auditable? created;
  Auditable? updated;
  Auditable? deleted;

  Area(
      {this.documentId,
      required this.name,
      required this.description,
      this.parent,
      this.path,
      required this.customer,
      this.calendars,
      this.teams,
      this.geoFence,
      this.created,
      this.updated,
      this.deleted}) {
    nameLower = name.toLowerCase();
  }

  Map<String, dynamic> toMap() {
    return {
      'documentId': documentId,
      'name': name,
      'description': description,
      'path': path,
      'customer': customer,
      'nameLower': name.toLowerCase(),
      'parent': parent?.map((key, value) => MapEntry(key, value?.toMap())) ?? {},
      'calendars': calendars?.map((key, value) => MapEntry(key, value?.toMap())) ?? {},
      'teams': teams?.map((key, value) => MapEntry(key, value?.toMap())),
      'geoFence': geoFence?.map((e) => e.toMap()).toList(), //Coords is a reference only object so an array of Coords will be stored in Firebase
      'created': created?.toMap(),
      'updated': updated?.toMap(),
      'deleted': deleted?.toMap()
    };
  }

  static Area? fromMap(Map<String, dynamic>? map) {
    Area? area;
    Map<String, Calendar?> calendarMap = {};
    Map<String, Team?> teamMap = {};
    Map<String, Area?> parentMap = {};

    if (map == null || map.isEmpty || map['documentId'] == null) {
      area = null;
    } else {
      if (map.containsKey('calendars') && map['calendars'] != null) {
        for (var key in map['calendars'].keys) {
          calendarMap[key] = Calendar.fromMap(map['calendars'][key]);
        }
      }

      if (map.containsKey('teams') && map['teams'] != null) {
        for (var key in map['teams'].keys) {
          teamMap[key] = Team.fromMap(map['teams'][key]);
        }
      }

      if (map.containsKey('parent') && map['parent'] != null) {
        for (var key in map['parent'].keys) {
          parentMap[key] = Area.fromMap(map['parent'][key]);
        }
      }

      area = Area(
          documentId: map.containsKey('documentId') ? map['documentId'] : null,
          name: map.containsKey('name') ? map['name'] : '',
          description: map.containsKey('description') ? map['description'] : '',
          parent: parentMap,
          path: map.containsKey('path') ? map['path'] : '',
          customer: map.containsKey('customer') ? map['customer'] : '',
          calendars: calendarMap,
          teams: teamMap,
          geoFence: map.containsKey('geoFence') ? map['geoFence'] : null,
          created: map.containsKey('created') ? Auditable.fromMap(map['created']) : null,
          updated: map.containsKey('updated') ? Auditable.fromMap(map['updated']) : null,
          deleted: map.containsKey('deleted') ? Auditable.fromMap(map['deleted']) : null);
    }

    return area;
  }

  static Map<String, Area?> populate(Map<String, dynamic> map) {
    Map<String, Area?> innerMap;

    innerMap = <String, Area?>{};

    for (var key in map.keys) {
      innerMap[key] = Area.fromMap(map[key]);
    }

    return innerMap;
  }

  AreaSnapshot toSnapshot() {
    return AreaSnapshot(documentId: documentId, name: name, description: description, path: path!);
  }
}

import 'package:hart_suite/models/general/auditable.dart';
import 'package:hart_suite/models/tag/tag_type.dart';

class Tag {
  String? documentId;
  String name;
  String payload;
  Map<String, TagType?> tagType;
  Auditable? created;
  Auditable? updated;
  Auditable? deleted;

  Tag({this.documentId, required this.name, required this.payload, required this.tagType, this.created, this.updated, this.deleted});

  Map<String, dynamic> toMap() {
    return {
      'documentId': documentId,
      'name': name,
      'payload': payload,
      'tagType': tagType.map((key, value) => MapEntry(key, value?.toMap())),
      'created': created?.toMap(),
      'updated': updated?.toMap(),
      'deleted': deleted?.toMap()
    };
  }

  static Tag? fromMap(Map<String, dynamic>? map) {
    Tag? tag;
    Map<String, TagType?> tagTypeMap = {};

    if (map == null || map.isEmpty || map['documentId'] == null) {
      tag = null;
    } else {
      if (map['tagType'] != null) {
        for (var key in map['tagType'].keys) {
          tagTypeMap[key] = TagType.fromMap(map['tagType'][key]);
        }
      }

      tag = Tag(
        documentId: map.containsKey('documentId') ? map['documentId'] : '',
        name: map.containsKey('name') ? map['name'] : '',
        payload: map.containsKey('payload') ? map['payload'] : '',
        tagType: tagTypeMap,
        created: map.containsKey('created') ? Auditable.fromMap(map['created']) : null,
        updated: map.containsKey('updated') ? Auditable.fromMap(map['updated']) : null,
        deleted: map.containsKey('deleted') ? Auditable.fromMap(map['deleted']) : null,
      );
    }

    return tag;
  }

  static Map<String, Tag?> populate(Map<String, dynamic> map) {
    Map<String, Tag?> innerMap;

    innerMap = <String, Tag?>{};

    for (var key in map.keys) {
      innerMap[key] = Tag.fromMap(map[key]);
    }

    return innerMap;
  }
}

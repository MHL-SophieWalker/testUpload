import 'package:hart_suite/models/app/app.dart';
import 'package:hart_suite/models/app/platform.dart';

class AppPlatform {
  String? documentId;
  Map<String, App?> app;
  Map<String, Platform?> platform;
  String resourceIdentifier; //this is the platform specific identifier (such as package name in Android)

  AppPlatform({this.documentId, required this.app, required this.platform, required this.resourceIdentifier}) {
    documentId ??= '${app.keys.first}_${platform.keys.first}';
  }

  Map<String, dynamic> toMap() {
    return {'documentId': documentId, 'app': app, 'platform': platform, 'resourceIdentifier': resourceIdentifier};
  }

  static AppPlatform? fromMap(Map<String, dynamic>? map) {
    AppPlatform? appPlatform;
    Map<String, App?> appMap = {};
    Map<String, Platform?> platformMap = {};

    if (map == null || map.isEmpty || map['documentId'] == null) {
      appPlatform = null;
    } else {
      if (map.containsKey('app') && map['app'] != null) {
        for (var key in map['app'].keys) {
          appMap[key] = App.fromMap(map['app'][key]);
        }
      }

      if (map.containsKey('platform') && map['platform'] != null) {
        for (var key in map['platform'].keys) {
          platformMap[key] = Platform.fromMap(map['platform'][key]);
        }
      }

      appPlatform = AppPlatform(
        documentId: map.containsKey('documentId') ? map['documentId'] : null,
        app: appMap,
        platform: platformMap,
        resourceIdentifier: map.containsKey('resourceIdentifier') ? map['resourceIdentifier'] : '',
      );
    }

    return appPlatform;
  }

  static Map<String, AppPlatform?> populate(Map<String, dynamic> map) {
    Map<String, AppPlatform?> innerMap;

    innerMap = <String, AppPlatform?>{};

    for (var key in map.keys) {
      innerMap[key] = AppPlatform.fromMap(map[key]);
    }

    return innerMap;
  }
}

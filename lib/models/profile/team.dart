import 'package:hart_suite/models/calendar/calendar.dart';
import 'package:hart_suite/models/discipline/discipline.dart';
import 'package:hart_suite/models/general/auditable.dart';
import 'package:hart_suite/models/profile/person.dart';
import 'package:hart_suite/models/profile/profile.dart';

class Team extends Profile {
  String name;
  String customer;
  Map<String, Calendar?>? calendar;
  Map<String, Person?>? leaders;
  Map<String, Person?>? members;
  late String nameLower;

  Team(
      {required this.name,
      required this.customer,
      this.calendar,
      this.leaders,
      this.members,
      super.documentId,
      super.disciplines,
      super.created,
      super.updated,
      super.deleted})
      : super() {
    nameLower = name.toLowerCase();
  }

  @override
  Map<String, dynamic> toMap() {
    return {
      'documentId': documentId,
      'name': name,
      'customer': customer,
      'nameLower': name.toLowerCase(),
      'calendar': calendar?.map((key, value) => MapEntry(key, value?.toMap())),
      'leaders': leaders?.map((key, value) => MapEntry(key, value?.toMap())),
      'members': members?.map((key, value) => MapEntry(key, value?.toMap())),
      'created': created?.toMap(),
      'updated': updated?.toMap(),
      'deleted': deleted?.toMap(),
      'disciplines': disciplines?.map((key, value) => MapEntry(key, value?.toMap()))
    };
  }

  static Team? fromMap(Map<String, dynamic>? map) {
    Team? team;
    Map<String, Discipline?> disciplineMap = {};
    Map<String, Calendar?> calendarMap = {};
    Map<String, Person?> leaderMap = {};
    Map<String, Person?> memberMap = {};

    if (map == null || map.isEmpty || map['documentId'] == null) {
      team = null;
    } else {
      if (map.containsKey('dicsiplines') && map['disciplines'] != null) {
        for (var key in map['disciplines'].keys) {
          disciplineMap[key] = Discipline.fromMap(map['disciplines'][key]);
        }
      }

      if (map.containsKey('calendar') && map['calendar'] != null) {
        for (var key in map['calendar'].keys) {
          calendarMap[key] = Calendar.fromMap(map['calendar'][key]);
        }
      }

      if (map.containsKey('leaders') && map['leaders'] != null) {
        for (var key in map['leaders'].keys) {
          leaderMap[key] = Person.fromMap(map['leaders'][key]);
        }
      }

      if (map.containsKey('members') && map['members'] != null) {
        for (var key in map['members'].keys) {
          memberMap[key] = Person.fromMap(map['members'][key]);
        }
      }

      team = Team(
        documentId: map.containsKey('documentId') ? map['documentId'] : null,
        name: map.containsKey('name') ? map['name'] : '',
        customer: map.containsKey('customer') ? map['customer'] : '',
        disciplines: disciplineMap,
        calendar: calendarMap,
        leaders: leaderMap,
        members: memberMap,
        created: map.containsKey('created') ? Auditable.fromMap(map['created']) : null,
        updated: map.containsKey('updated') ? Auditable.fromMap(map['updated']) : null,
        deleted: map.containsKey('deleted') ? Auditable.fromMap(map['deleted']) : null,
      );
    }

    return team;
  }

  static Map<String, Team?> populate(Map<String, dynamic> map) {
    Map<String, Team?> innerMap;

    innerMap = <String, Team?>{};

    for (var key in map.keys) {
      innerMap[key] = Team.fromMap(map[key]);
    }

    return innerMap;
  }
}

import 'package:hart_suite/models/general/auditable.dart';
import 'package:hart_suite/models/profile/person.dart';
import 'package:hart_suite/models/profile/team.dart';

class TeamPerson {
  String? documentId;
  Map<String, Team?> team;
  Map<String, Person?> person;
  Auditable? created;
  Auditable? updated;
  Auditable? deleted;

  TeamPerson({this.documentId, required this.team, required this.person, this.created, this.updated, this.deleted}) {
    documentId ??= '${team.keys.first}_${person.keys.first}';
  }

  Map<String, dynamic> toMap() {
    return {
      'documentId': documentId,
      'team': team.map((key, value) => MapEntry(key, value?.toMap())),
      'person': person.map((key, value) => MapEntry(key, value?.toMap())),
      'created': created?.toMap(),
      'updated': updated?.toMap(),
      'deleted': deleted?.toMap()
    };
  }

  static TeamPerson? fromMap(Map<String, dynamic>? map) {
    TeamPerson? teamPerson;
    Map<String, Team?> teamMap = {};
    Map<String, Person?> personMap = {};

    if (map == null || map.isEmpty || map['documentId'] == null) {
      teamPerson = null;
    } else {
      if (map.containsKey('team') && map['team'] != null) {
        for (var key in map['team'].keys) {
          teamMap[key] = Team.fromMap(map['team'][key]);
        }
      }

      if (map.containsKey('person') && map['person'] != null) {
        for (var key in map['person'].keys) {
          personMap[key] = Person.fromMap(map['person'][key]);
        }
      }

      teamPerson = TeamPerson(
        documentId: map.containsKey('documentId') ? map['documentId'] : null,
        team: teamMap,
        person: personMap,
        created: map.containsKey('created') ? Auditable.fromMap(map['created']) : null,
        updated: map.containsKey('updated') ? Auditable.fromMap(map['updated']) : null,
        deleted: map.containsKey('deleted') ? Auditable.fromMap(map['deleted']) : null,
      );
    }

    return teamPerson;
  }

  static Map<String, TeamPerson?> populate(Map<String, dynamic> map) {
    Map<String, TeamPerson?> innerMap;

    innerMap = <String, TeamPerson?>{};

    for (var key in map.keys) {
      innerMap[key] = TeamPerson.fromMap(map[key]);
    }

    return innerMap;
  }
}

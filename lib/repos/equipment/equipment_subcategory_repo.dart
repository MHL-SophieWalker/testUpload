import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:hart_suite/helpers/firebase/firestore_helper.dart';
import 'package:hart_suite/models/equipment/equipment_category.dart';
import 'package:hart_suite/models/equipment/equipment_subcategory.dart';
import 'package:hart_suite/models/general/auditable.dart';
import 'package:hart_suite/models/profile/person_snapshot.dart';
import 'package:hart_suite/repos/equipment/equipment_category_repo.dart';

class EquipmentSubcategoryRepo {
  final String collectionName = 'equipmentSubcategories';
  final String basePath = 'customers';
  late String customer;
  late String path;
  late PersonSnapshot? personSnapshot;

  EquipmentSubcategoryRepo({bool useMocks = false, this.personSnapshot, required this.customer}) {
    path = '$basePath/$customer/$collectionName';
    FirestoreHelper.useMocks = useMocks;
  }

  setPersonSnapshot(PersonSnapshot personSnapshot) {
    this.personSnapshot = personSnapshot;
  }

  Future<List<EquipmentSubcategory>> get({bool populate = false}) async {
    List<EquipmentSubcategory> equipmentSubcategories = List.empty(growable: true);

    await FirestoreHelper.instance?.getDataCollection(path: path).then((value) {
      if (value.docs.isNotEmpty) {
        for (var d in value.docs) {
          equipmentSubcategories.add(fromDocumentSnapshot(d));
        }
      }
    });

    if (populate && equipmentSubcategories.isNotEmpty) {
      populateItems(equipmentSubcategories: equipmentSubcategories).then((value) => equipmentSubcategories = value);
    }

    return equipmentSubcategories;
  }

  Future<EquipmentSubcategory?> getById({required String id, bool populate = false}) async {
    EquipmentSubcategory? equipmentSubcategory;

    equipmentSubcategory = null;

    await FirestoreHelper.instance?.getDocumentById(path: path, id: id).then((value) {
      if (value.exists) {
        equipmentSubcategory = fromDocumentSnapshot(value);
      }
    });

    if (populate && equipmentSubcategory != null) {
      populateItem(equipmentSubCategory: equipmentSubcategory!).then((value) => equipmentSubcategory = value);
    }

    return equipmentSubcategory;
  }

  Future<void> update({required EquipmentSubcategory equipmentSubcategory}) async {
    Auditable audit = Auditable(person: personSnapshot, dateStamp: DateTime.now());

    equipmentSubcategory.updated = audit;

    await FirestoreHelper.instance?.updateDocument(path: path, data: equipmentSubcategory.toMap(), id: equipmentSubcategory.documentId!);
  }

  Future<void> add({required EquipmentSubcategory equipmentSubcategory}) async {
    Auditable audit = Auditable(person: personSnapshot, dateStamp: DateTime.now());

    equipmentSubcategory.created = audit;

    await FirestoreHelper.instance?.addDocument(path: path, data: equipmentSubcategory.toMap()).then((value) => equipmentSubcategory.documentId = value.id);
  }

  Stream getStream() {
    return FirestoreHelper.instance?.streamDataCollection(path: path) ?? const Stream.empty();
  }

  Future<List<EquipmentSubcategory>> populateItems({required List<EquipmentSubcategory> equipmentSubcategories}) async {
    for (var equipmentSubCategory in equipmentSubcategories) {
      await populateItem(equipmentSubCategory: equipmentSubCategory).then((value) => equipmentSubCategory = value);
    }

    return equipmentSubcategories;
  }

  Future<EquipmentSubcategory> populateItem({required EquipmentSubcategory equipmentSubCategory}) async {
    EquipmentCategoryRepo equipmentCategoryRepo;

    equipmentCategoryRepo = EquipmentCategoryRepo(personSnapshot: personSnapshot, customer: customer);

    for (var key in equipmentSubCategory.equipmentCategory.keys) {
      await equipmentCategoryRepo.getById(id: key).then((value) => equipmentSubCategory.equipmentCategory[key] = value);
    }

    return equipmentSubCategory;
  }

  static EquipmentSubcategory fromDocumentSnapshot(DocumentSnapshot<Object?> value) {
    EquipmentSubcategory equipmentSubcategory;
    Map<String, dynamic> data;
    Map<String, EquipmentCategory?> equipmentCategoryMap;

    equipmentCategoryMap = {};

    data = value.data() as Map<String, dynamic>;

    if (data.containsKey('equipmentCategory') && data['equipmentCategory'] != null) {
      for (var key in data['equipmentCategory'].keys) {
        equipmentCategoryMap[key] = EquipmentCategory.fromMap(data['equipmentCategory'][key]);
      }
    }

    equipmentSubcategory = EquipmentSubcategory(
        documentId: value.id,
        name: data.containsKey('name') ? data['name'] : '',
        equipmentCategory: equipmentCategoryMap,
        created: data.containsKey('created') ? Auditable.fromMap(data['created']) : null,
        updated: data.containsKey('updated') ? Auditable.fromMap(data['updated']) : null,
        deleted: data.containsKey('deleted') ? Auditable.fromMap(data['deleted']) : null);

    return equipmentSubcategory;
  }
}

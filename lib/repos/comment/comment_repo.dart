import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:hart_suite/enums/comment_type.dart';
import 'package:hart_suite/helpers/firebase/firestore_helper.dart';
import 'package:hart_suite/models/app/app.dart';
import 'package:hart_suite/models/attachment/attachment.dart';
import 'package:hart_suite/models/comment/comment.dart';
import 'package:hart_suite/models/general/auditable.dart';
import 'package:hart_suite/models/profile/person_snapshot.dart';
import 'package:hart_suite/repos/app/app_repo.dart';
import 'package:hart_suite/repos/attachment/attachment_repo.dart';

class CommentRepo {
  final String collectionName = 'comments';
  late String basePath = 'customers';
  late String customer;
  late String path;
  late PersonSnapshot? personSnapshot;

  CommentRepo({bool useMocks = false, this.personSnapshot, required this.customer}) {
    path = '$basePath/$customer/$collectionName';
    FirestoreHelper.useMocks = useMocks;
  }

  setPersonSnapshot(PersonSnapshot personSnapshot) {
    this.personSnapshot = personSnapshot;
  }

  Future<List<Comment>> get({bool populate = false}) async {
    List<Comment> comments = List.empty(growable: true);

    await FirestoreHelper.instance?.getDataCollection(path: path).then((value) {
      if (value.docs.isNotEmpty) {
        for (var d in value.docs) {
          comments.add(fromDocumentSnapshot(d));
        }
      }
    });

    comments.sort((a, b) => a.created!.dateStamp!.compareTo(b.created!.dateStamp!));

    if (populate && comments.isNotEmpty) {
      await populateItems(comments: comments).then((value) => comments = value);
    }

    return comments;
  }

  Future<Comment?> getById({required String id, bool populate = false}) async {
    Comment? comment;

    comment = null;

    await FirestoreHelper.instance?.getDocumentById(path: path, id: id).then((value) {
      if (value.exists) {
        comment = fromDocumentSnapshot(value);
      }
    });

    if (populate && comment != null) {
      await populateItem(comment: comment!).then((value) => comment = value);
    }

    return comment;
  }

  Future<void> update({required Comment comment}) async {
    Auditable audit = Auditable(person: personSnapshot, dateStamp: DateTime.now());

    comment.updated = audit;

    await FirestoreHelper.instance?.updateDocument(path: path, data: comment.toMap(), id: comment.documentId!);
  }

  Future<void> add({required Comment comment}) async {
    Auditable audit = Auditable(person: personSnapshot, dateStamp: DateTime.now());

    comment.created = audit;

    await FirestoreHelper.instance?.addDocument(path: path, data: comment.toMap()).then((value) => comment.documentId = value.id);
  }

  Stream getStream() {
    return FirestoreHelper.instance?.streamDataCollection(path: path) ?? const Stream.empty();
  }

  Future<List<Comment>> populateItems({required List<Comment> comments}) async {
    for (var comment in comments) {
      populateItem(comment: comment);
    }

    return comments;
  }

  Future<Comment> populateItem({required Comment comment}) async {
    AppRepo appRepo;
    AttachmentRepo attachmentRepo;

    appRepo = AppRepo(personSnapshot: personSnapshot);
    attachmentRepo = AttachmentRepo(personSnapshot: personSnapshot, customer: customer);

    if (comment.app != null) {
      for (var key in comment.app!.keys) {
        await appRepo.getById(id: key).then((value) => comment.app![key] = value!);
      }
    }
    if (comment.attachments != null) {
      for (var key in comment.attachments!.keys) {
        await attachmentRepo.getById(id: key).then((value) => comment.attachments![key] = value!);
      }
    }

    return comment;
  }

  static Comment fromDocumentSnapshot(DocumentSnapshot<Object?> value) {
    Comment comment;
    Map<String, App?> appMap;
    Map<String, Attachment?> attachmentMap;
    Map<String, dynamic> data;

    appMap = {};
    attachmentMap = {};

    data = value.data() as Map<String, dynamic>;

    if (data.containsKey('app') && data['app'] != null) {
      for (var key in data['app'].keys) {
        appMap[key] = App.fromMap(data['app'][key]);
      }
    }

    if (data.containsKey('attachments') && data['attachments'] != null) {
      for (var key in data['attachments'].keys) {
        attachmentMap[key] = Attachment.fromMap(data['attachments'][key]);
      }
    }

    comment = Comment(
        documentId: value.id,
        app: appMap,
        content: data.containsKey('content') ? data['content'] : '',
        attachments: attachmentMap,
        created: data.containsKey('created') ? Auditable.fromMap(data['created']) : null,
        updated: data.containsKey('updated') ? Auditable.fromMap(data['updated']) : null,
        deleted: data.containsKey('deleted') ? Auditable.fromMap(data['deleted']) : null,
        type: data.containsKey('type') ? CommentType.values.where((t) => t.name == data['type']).first : CommentType.general);

    return comment;
  }
}

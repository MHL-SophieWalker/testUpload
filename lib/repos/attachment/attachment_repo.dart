import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:hart_suite/helpers/firebase/firestore_helper.dart';
import 'package:hart_suite/models/attachment/attachment.dart';
import 'package:hart_suite/models/general/auditable.dart';
import 'package:hart_suite/models/profile/person_snapshot.dart';

class AttachmentRepo {
  final String basePath = 'customers';
  final String collectionName = 'attachments';
  late String path;
  late String customer;
  late PersonSnapshot? personSnapshot;

  AttachmentRepo({bool useMocks = false, this.personSnapshot, required this.customer}) {
    path = '$basePath/$customer/$collectionName';
    FirestoreHelper.useMocks = useMocks;
  }

  setPersonSnapshot(PersonSnapshot personSnapshot) {
    this.personSnapshot = personSnapshot;
  }

  Future<List<Attachment>> get() async {
    List<Attachment> attachments = List.empty(growable: true);

    await FirestoreHelper.instance?.getDataCollection(path: path).then((value) {
      if (value.docs.isNotEmpty) {
        for (var d in value.docs) {
          attachments.add(fromDocumentSnapshot(d));
        }
      }
    });

    return attachments;
  }

  Future<Attachment?> getById({required String id}) async {
    Attachment? attachment;

    attachment = null;

    await FirestoreHelper.instance?.getDocumentById(path: path, id: id).then((value) {
      if (value.exists) {
        attachment = fromDocumentSnapshot(value);
      }
    });

    return attachment;
  }

  Future<void> update({required Attachment attachment}) async {
    Auditable audit = Auditable(person: personSnapshot, dateStamp: DateTime.now());

    attachment.updated = audit;

    await FirestoreHelper.instance?.updateDocument(path: path, data: attachment.toMap(), id: attachment.documentId!);
  }

  Future<void> add({required Attachment attachment}) async {
    Auditable audit = Auditable(person: personSnapshot, dateStamp: DateTime.now());

    attachment.created = audit;

    await FirestoreHelper.instance?.addDocument(path: path, data: attachment.toMap()).then((value) => attachment.documentId = value.id);
  }

  Stream getStream() {
    return FirestoreHelper.instance?.streamDataCollection(path: path) ?? const Stream.empty();
  }

  static Attachment fromDocumentSnapshot(DocumentSnapshot<Object?> value) {
    Attachment attachment;
    Map<String, dynamic> data;

    data = value.data() as Map<String, dynamic>;

    attachment = Attachment(
        documentId: value.id,
        fileName: data.containsKey('fileName') ? data['fileName'] : '',
        fileLocation: data.containsKey('fileLocation') ? data['fileLocation'] : '',
        created: data.containsKey('created') ? Auditable.fromMap(data['created']) : null,
        updated: data.containsKey('updated') ? Auditable.fromMap(data['updated']) : null,
        deleted: data.containsKey('deleted') ? Auditable.fromMap(data['deleted']) : null,
        isOnline: data.containsKey('isOnline') ? data['isOnline'] : false);

    return attachment;
  }
}

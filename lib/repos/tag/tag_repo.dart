import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:hart_suite/helpers/firebase/firestore_helper.dart';
import 'package:hart_suite/models/general/auditable.dart';
import 'package:hart_suite/models/profile/person_snapshot.dart';
import 'package:hart_suite/models/tag/tag.dart';
import 'package:hart_suite/models/tag/tag_type.dart';
import 'package:hart_suite/repos/tag/tag_type_repo.dart';

class TagRepo {
  final String basePath = 'customers';
  final String collectionName = 'tags';
  late String customer;
  late String path;
  late PersonSnapshot? personSnapshot;

  TagRepo({bool useMocks = false, this.personSnapshot, required this.customer}) {
    path = '$basePath/$customer/$collectionName';
    FirestoreHelper.useMocks = useMocks;
  }

  setPersonSnapshot(PersonSnapshot personSnapshot) {
    this.personSnapshot = personSnapshot;
  }

  Future<List<Tag>> get({bool populate = false}) async {
    List<Tag> tags = List.empty(growable: true);

    await FirestoreHelper.instance?.getDataCollection(path: path).then((value) {
      if (value.docs.isNotEmpty) {
        for (var d in value.docs) {
          tags.add(fromDocumentSnapshot(d));
        }

        tags.sort((a, b) => a.name.compareTo(b.name));
      }
    });

    if (populate && tags.isNotEmpty) {
      await populateItems(tags: tags).then((value) => tags = value);
    }

    return tags;
  }

  Future<Tag?> getById({required String id, bool populate = false}) async {
    Tag? tag;

    tag = null;

    await FirestoreHelper.instance?.getDocumentById(path: path, id: id).then((value) {
      if (value.exists) {
        tag = fromDocumentSnapshot(value);
      }
    });

    if (populate && tag != null) {
      await populateItem(tag: tag!).then((value) => tag = value);
    }

    return tag;
  }

  Future<void> update({required Tag tag}) async {
    Auditable audit = Auditable(person: personSnapshot, dateStamp: DateTime.now());

    tag.updated = audit;

    await FirestoreHelper.instance?.updateDocument(path: path, data: tag.toMap(), id: tag.documentId!);
  }

  Future<void> add({required Tag tag}) async {
    Auditable audit = Auditable(person: personSnapshot, dateStamp: DateTime.now());

    tag.created = audit;

    await FirestoreHelper.instance?.addDocument(path: path, data: tag.toMap()).then((value) => tag.documentId = value.id);
  }

  Stream getStream() {
    return FirestoreHelper.instance?.streamDataCollection(path: path) ?? const Stream.empty();
  }

  Future<List<Tag>> populateItems({required List<Tag> tags}) async {
    for (var tag in tags) {
      await populateItem(tag: tag).then((value) => tag = value);
    }

    return tags;
  }

  Future<Tag> populateItem({required Tag tag}) async {
    TagTypeRepo tagTypeRepo;

    tagTypeRepo = TagTypeRepo(personSnapshot: personSnapshot, customer: customer);

    for (String tt in tag.tagType.keys) {
      await tagTypeRepo.getById(id: tt).then((value) => tag.tagType[tt] = value);
    }

    return tag;
  }

  static Tag fromDocumentSnapshot(DocumentSnapshot<Object?> value) {
    Tag tag;
    Map<String, dynamic> data;
    Map<String, TagType?> tagTypeMap;

    tagTypeMap = {};

    data = value.data() as Map<String, dynamic>;

    if (data.containsKey('tagType')) {
      for (var key in data['tagType'].keys) {
        tagTypeMap[key] = TagType.fromMap(data['tagType'][key]);
      }
    }

    tag = Tag(
        documentId: value.id,
        name: data.containsKey('name') ? data['name'] : '',
        payload: data.containsKey('payload') ? data['payload'] : '',
        tagType: tagTypeMap,
        created: data.containsKey('created') ? Auditable.fromMap(data['created']) : null,
        updated: data.containsKey('updated') ? Auditable.fromMap(data['updated']) : null,
        deleted: data.containsKey('deleted') ? Auditable.fromMap(data['deleted']) : null);

    return tag;
  }
}

import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:hart_suite/helpers/firebase/firestore_helper.dart';
import 'package:hart_suite/models/general/auditable.dart';
import 'package:hart_suite/models/profile/person_snapshot.dart';
import 'package:hart_suite/models/tag/tag_type.dart';

class TagTypeRepo {
  final String basePath = 'customers';
  final String collectionName = 'tagTypes';
  late String customer;
  late String path;
  late PersonSnapshot? personSnapshot;

  TagTypeRepo({bool useMocks = false, this.personSnapshot, required this.customer}) {
    path = '$basePath/$customer/$collectionName';
    FirestoreHelper.useMocks = useMocks;
  }

  setPersonSnapshot(PersonSnapshot personSnapshot) {
    this.personSnapshot = personSnapshot;
  }

  Future<List<TagType>> get() async {
    List<TagType> tagTypes = List.empty(growable: true);

    FirestoreHelper.instance?.getDataCollection(path: path).then((value) {
      if (value.docs.isNotEmpty) {
        for (var d in value.docs) {
          tagTypes.add(fromDocumentSnapshot(d));
        }

        tagTypes.sort((a, b) => a.name.compareTo(b.name));
      }
    });

    return tagTypes;
  }

  Future<TagType?> getById({required String id}) async {
    TagType? tagType;

    tagType = null;

    await FirestoreHelper.instance?.getDocumentById(path: path, id: id).then((value) {
      if (value.exists) {
        tagType = fromDocumentSnapshot(value);
      }
    });

    return tagType;
  }

  Future<void> update({required TagType tagType}) async {
    Auditable audit = Auditable(person: personSnapshot, dateStamp: DateTime.now());

    tagType.updated = audit;

    await FirestoreHelper.instance?.updateDocument(path: path, data: tagType.toMap(), id: tagType.documentId);
  }

  Future<void> add({required TagType tagType}) async {
    Auditable audit = Auditable(person: personSnapshot, dateStamp: DateTime.now());

    tagType.created = audit;

    await FirestoreHelper.instance?.addDocument(path: path, data: tagType.toMap()).then((value) => tagType.documentId = value.id);
  }

  Stream getStream() {
    return FirestoreHelper.instance?.streamDataCollection(path: path) ?? const Stream.empty();
  }

  static TagType fromDocumentSnapshot(DocumentSnapshot<Object?> value) {
    TagType tagType;
    Map<String, dynamic> data;

    data = value.data() as Map<String, dynamic>;

    tagType = TagType(
        documentId: value.id,
        name: data.containsKey('name') ? data['name'] : '',
        created: data.containsKey('created') ? Auditable.fromMap(data['created']) : null,
        updated: data.containsKey('updated') ? Auditable.fromMap(data['updated']) : null,
        deleted: data.containsKey('deleted') ? Auditable.fromMap(data['deleted']) : null);

    return tagType;
  }
}

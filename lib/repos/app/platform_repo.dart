import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:hart_suite/helpers/firebase/firestore_helper.dart';
import 'package:hart_suite/models/app/platform.dart';
import 'package:hart_suite/models/profile/person_snapshot.dart';

class PlatformRepo {
  final String collectionName = 'platforms';
  late PersonSnapshot? personSnapshot;

  PlatformRepo({bool useMocks = false, this.personSnapshot}) {
    FirestoreHelper.useMocks = useMocks;
  }

  setPersonSnapshot(PersonSnapshot personSnapshot) {
    this.personSnapshot = personSnapshot;
  }

  Future<List<Platform>> get() async {
    List<Platform> platforms = List.empty(growable: true);

    await FirestoreHelper.instance?.getDataCollection(path: collectionName).then((value) {
      if (value.docs.isNotEmpty) {
        for (var d in value.docs) {
          platforms.add(fromDocumentSnapshot(d));
        }

        platforms.sort((a, b) => a.name.compareTo(b.name));
      }
    });

    return platforms;
  }

  Future<Platform?> getById({required String id}) async {
    Platform? platform;

    platform = null;

    await FirestoreHelper.instance?.getDocumentById(path: collectionName, id: id).then((value) {
      if (value.exists) {
        platform = fromDocumentSnapshot(value);
      }
    });

    return platform;
  }

  Future<void> update({required Platform platform}) async {
    await FirestoreHelper.instance?.updateDocument(path: collectionName, data: platform.toMap(), id: platform.documentId!);
  }

  Future<void> add({required Platform platform}) async {
    await FirestoreHelper.instance?.addDocument(path: collectionName, data: platform.toMap()).then((value) => platform.documentId = value.id);
  }

  Stream getStream() {
    return FirestoreHelper.instance?.streamDataCollection(path: collectionName) ?? const Stream.empty();
  }

  static Platform fromDocumentSnapshot(DocumentSnapshot<Object?> value) {
    Platform platform;
    Map<String, dynamic> data;

    data = value.data() as Map<String, dynamic>;

    platform = Platform(documentId: value.id, name: data.containsKey('name') ? data['name'] : '');

    return platform;
  }
}

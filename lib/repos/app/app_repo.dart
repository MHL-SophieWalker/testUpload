import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:hart_suite/helpers/firebase/firestore_helper.dart';
import 'package:hart_suite/models/app/app.dart';
import 'package:hart_suite/models/profile/person_snapshot.dart';

class AppRepo {
  final String collectionName = 'apps';
  final String basePath = 'customers';
  late String? customer;
  late String path;
  late PersonSnapshot? personSnapshot;

  AppRepo({bool useMocks = false, this.personSnapshot, this.customer}) {
    if (customer == null) {
      path = collectionName;
    } else {
      path = '$basePath/$customer/$collectionName';
    }

    FirestoreHelper.useMocks = useMocks;
  }

  setPersonSnapshot(PersonSnapshot personSnapshot) {
    this.personSnapshot = personSnapshot;
  }

  Future<List<App>> get() async {
    List<App> apps = List.empty(growable: true);

    await FirestoreHelper.instance?.getDataCollection(path: path).then((value) {
      if (value.docs.isNotEmpty) {
        for (var d in value.docs) {
          apps.add(fromDocumentSnapshot(d));
        }

        apps.sort((a, b) => a.name.compareTo(b.name));
      }
    });

    return apps;
  }

  Future<App?> getById({required String id}) async {
    App? app;

    app = null;

    await FirestoreHelper.instance?.getDocumentById(path: path, id: id).then((value) {
      if (value.exists) {
        app = fromDocumentSnapshot(value);
      }
    });

    return app;
  }

  Future<void> update({required App app}) async {
    await FirestoreHelper.instance?.updateDocument(path: path, data: app.toMap(), id: app.documentId!);
  }

  Future<void> add({required App app}) async {
    await FirestoreHelper.instance?.addDocument(path: path, data: app.toMap()).then((value) => app.documentId = value.id);
  }

  Stream getStream() {
    return FirestoreHelper.instance?.streamDataCollection(path: path) ?? const Stream.empty();
  }

  static App fromDocumentSnapshot(DocumentSnapshot<Object?> value) {
    App app;
    Map<String, dynamic> data;

    data = value.data() as Map<String, dynamic>;

    app = App(
      documentId: value.id,
      name: data.containsKey('name') ? data['name'] : '',
    );

    return app;
  }
}

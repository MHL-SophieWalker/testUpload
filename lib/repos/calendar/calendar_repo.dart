import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:hart_suite/helpers/firebase/firestore_helper.dart';
import 'package:hart_suite/models/calendar/calendar.dart';
import 'package:hart_suite/models/general/auditable.dart';
import 'package:hart_suite/models/profile/person_snapshot.dart';

class CalendarRepo {
  final String collectionName = 'calendars';
  final String basePath = 'customers';
  late String path;
  late String customer;
  late PersonSnapshot? personSnapshot;

  CalendarRepo({bool useMocks = false, this.personSnapshot, required this.customer}) {
    path = '$basePath/$customer/$collectionName';
    FirestoreHelper.useMocks = useMocks;
  }

  setPersonSnapshot(PersonSnapshot personSnapshot) {
    this.personSnapshot = personSnapshot;
  }

  Future<List<Calendar>> get() async {
    List<Calendar> calendars = List.empty(growable: true);

    await FirestoreHelper.instance?.getDataCollection(path: path).then((value) {
      if (value.docs.isNotEmpty) {
        for (var d in value.docs) {
          calendars.add(fromDocumentSnapshot(d));
        }
      }
    });

    calendars.sort((a, b) => a.name.compareTo(b.name));

    return calendars;
  }

  Future<Calendar?> getById({required String id}) async {
    Calendar? calendar;

    calendar = null;

    await FirestoreHelper.instance?.getDocumentById(path: path, id: id).then((value) {
      if (value.exists) {
        calendar = fromDocumentSnapshot(value);
      }
    });

    return calendar;
  }

  Future<void> update({required Calendar calendar}) async {
    Auditable audit = Auditable(person: personSnapshot, dateStamp: DateTime.now());

    calendar.updated = audit;

    await FirestoreHelper.instance?.updateDocument(path: path, data: calendar.toMap(), id: calendar.documentId!);
  }

  Future<void> add({required Calendar calendar}) async {
    Auditable audit = Auditable(person: personSnapshot, dateStamp: DateTime.now());

    calendar.created = audit;

    await FirestoreHelper.instance?.addDocument(path: path, data: calendar.toMap()).then((value) => calendar.documentId = value.id);
  }

  Stream getStream() {
    return FirestoreHelper.instance?.streamDataCollection(path: path) ?? const Stream.empty();
  }

  static Calendar fromDocumentSnapshot(DocumentSnapshot<Object?> value) {
    Calendar calendar;
    Map<String, dynamic> data;

    data = value.data() as Map<String, dynamic>;

    calendar = Calendar(
        documentId: value.id,
        name: data.containsKey('name') ? data['name'] : '',
        description: data.containsKey('description') ? data['description'] : '',
        created: data.containsKey('created') ? Auditable.fromMap(data['created']) : null,
        updated: data.containsKey('updated') ? Auditable.fromMap(data['updated']) : null,
        deleted: data.containsKey('deleted') ? Auditable.fromMap(data['deleted']) : null,
        datePoints:
            data.containsKey('datePoints') && data['datePoints'] != null ? data['datePoints'].forEach((element) => (element as Timestamp).toDate()) : List<DateTime>.empty(growable: true));

    return calendar;
  }
}

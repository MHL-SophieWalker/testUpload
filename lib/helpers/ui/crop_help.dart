import 'dart:io';

import 'package:camera/camera.dart';
import 'package:firebase_storage/firebase_storage.dart';
import 'package:flutter/foundation.dart';
import 'package:flutter/material.dart';
import 'package:hart_suite/error_handler.dart';
import 'package:hart_suite/helpers/firebase/firebase_storage_helper.dart';
import 'package:hart_suite/models/profile/person.dart';
import 'package:image_cropper/image_cropper.dart';
import 'package:path_provider/path_provider.dart';
import 'package:image/image.dart' as img;

class CropHelp {
  static Future<UploadTask?> cropImage({required BuildContext context, required Person person, XFile? cropped}) async {
    XFile file;
    File mobileFile;
    String path;
    UploadTask? uploadTask;

    if (cropped != null) {
      file = cropped;
    } else {
      file = await FirebaseStorage.instance
          .ref()
          .child(person.getImagePathString())
          .getDownloadURL()
          .then(
            (value) => XFile(value),
          )
          .onError((error, stackTrace) => ErrorHandler.logError(exception: error, stack: stackTrace));
    }

    path = file.path;

    if (!kIsWeb && cropped == null) {
      final appDocDir = await getApplicationDocumentsDirectory();
      path = '${appDocDir.path}/images/profileCropped.jpg';

      await FirebaseStorage.instance
          .ref()
          .child(person.getImagePathString())
          .getData()
          .then(
            (value) async => {
              mobileFile = File(path),
              if (!mobileFile.existsSync())
                {
                  mobileFile.createSync(recursive: true),
                },
              await mobileFile.writeAsBytes(value as List<int>),
              path = mobileFile.path,
            },
          )
          .onError((error, stackTrace) => ErrorHandler.logError(exception: error, stack: stackTrace));
    }

    CroppedFile? croppedFile = await ImageCropper().cropImage(
      sourcePath: path,
      uiSettings: [
        AndroidUiSettings(
            toolbarTitle: 'Cropper',
            toolbarColor: Colors.deepOrange,
            toolbarWidgetColor: Colors.white,
            initAspectRatio: CropAspectRatioPreset.original,
            lockAspectRatio: false),
        IOSUiSettings(title: 'Cropper'),
        WebUiSettings(
          // ignore: use_build_context_synchronously
          context: context,
          minCropBoxHeight: 50,
          minCropBoxWidth: 50,
          presentStyle: WebPresentStyle.page,
        ),
      ],
      maxWidth: 500,
      maxHeight: 500,
    );

    if (croppedFile != null) {
      var bytes = await croppedFile.readAsBytes();

      uploadTask = await FirebaseStorageHelper.uploadImage(
        destImage: img.decodeImage(bytes)!,
        image: XFile.fromData(bytes),
        remotePath: person.getImagePathString(),
        cropPath: croppedFile.path,
      ).then(
        (value) => uploadTask = value,
      );
    } else {
      uploadTask = null;
    }

    if (kIsWeb) {
      return Future.value(uploadTask);
    } else {
      return uploadTask;
    }
  }
}

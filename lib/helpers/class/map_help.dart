class MapHelp {
  static String getFirstKey({required Map? map}) {
    String key;

    key = '';

    if (map != null && map.isNotEmpty) {
      key = map.keys.first;
    }

    return key;
  }

  /// Checks if two maps are equal.
  ///
  /// Returns `true` if the two maps are equal, `false` otherwise.
  /// Two maps are considered equal if they have the same keys and values.
  /// If the maps contain nested maps, the nested maps are also compared recursively.
  /// If any nested map is not equal, the function returns `false`.
  /// If the maps are empty, they are considered equal.
  ///
  /// Example usage:
  /// ```dart
  /// Map<String, dynamic> map1 = {'name': 'John', 'age': 30};
  /// Map<String, dynamic> map2 = {'name': 'John', 'age': 30};
  /// bool result = equals(map1, map2); // returns true
  /// ```
  static bool equals(Map<String, dynamic> map, Map<String, dynamic> map2) {
    if (map2.length != map.length) {
      return false;
    }

    if (map2.keys.length != map.keys.length) {
      return false;
    }

    if (!map2.keys.every((element) => map.keys.contains(element)) || !map.keys.every((element) => map2.keys.contains(element))) {
      return false;
    }

    for (var key in map2.keys) {
      map2[key] ??= '';
      map[key] ??= '';

      if (map2[key] is Map<String, Map<String, dynamic>?> && map2[key].isNotEmpty && map[key].isNotEmpty) {
        if (!(map2[key] as Map<String, dynamic>).keys.every((String element) => (map[key] as Map<String, dynamic>).keys.contains(element)) ||
            !(map[key] as Map<String, dynamic>).keys.every((String element) => (map2[key] as Map<String, dynamic>).keys.contains(element))) {
          return false;
        }

        for (var innerKey in map2[key].keys) {
          if ((map2[key][innerKey] == null && map[key][innerKey] != null) || (map2[key][innerKey] != null && map[key][innerKey] == null)) {
            return false;
          }

          if (!equals(map2[key][innerKey] as Map<String, dynamic>, map[key][innerKey] as Map<String, dynamic>)) {
            return false;
          }
        }
      } else if (map2[key] is List && map[key] is List) {
        if (!equalsList(map2[key], map[key])) {
          return false;
        }
      } else if (map2[key] is Map<String, dynamic>) {
        if ((map2[key].isNotEmpty && map[key].isEmpty) || (map2[key].isEmpty && map[key].isNotEmpty)) {
          return false;
        }

        if (!equals(map2[key], map[key])) {
          return false;
        }
      } else if (map[key] is Map && map2[key] is Map && map[key].isEmpty && map2[key].isEmpty) {
        // return true;
      } else if (map2[key] != map[key]) {
        return false;
      }
    }

    return true;
  }

  static bool equalsList(List list, List list2) {
    if (list.length != list2.length) {
      return false;
    }

    for (var i = 0; i < list.length; i++) {
      if (list[i] is Map<String, dynamic> && list2[i] is Map<String, dynamic>) {
        if (!equals(list[i], list2[i])) {
          return false;
        }
      } else if (list[i] is List && list2[i] is List) {
        if (!equalsList(list[i], list2[i])) {
          return false;
        }
      } else if (list[i] != list2[i]) {
        return false;
      }
    }

    return true;
  }
}

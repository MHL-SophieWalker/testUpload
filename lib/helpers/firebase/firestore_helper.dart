import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:fake_cloud_firestore/fake_cloud_firestore.dart';

class FirestoreHelper {
  static FirestoreHelper? _instance;
  static late FirebaseFirestore _firestore;
  static bool useMocks = false;

  static FirestoreHelper? get instance {
    _instance ??= FirestoreHelper._init();
    return _instance;
  }

  FirestoreHelper._init() {
    if (useMocks) {
      _firestore = FakeFirebaseFirestore();
    } else {
      _firestore = FirebaseFirestore.instance;

      //We can only enable persistance on the real firestore, the fakes cannot handle this setting and will now throw an error
      _firestore.settings = const Settings(
        persistenceEnabled: true,
        cacheSizeBytes: Settings.CACHE_SIZE_UNLIMITED,
        webExperimentalLongPollingOptions: WebExperimentalLongPollingOptions(timeoutDuration: Duration(seconds: 25)),
      );
    }
  }

  Future<dynamic> runTransaction(Future<dynamic> Function(Transaction) transactionHandler) async {
    return await _firestore.runTransaction(transactionHandler);
  }

  Future<QuerySnapshot> getDataCollection({required String path}) async {
    return await _firestore.collection(path).where('deleted', isNull: true).get();
  }

  Future<QuerySnapshot> getDataCollectionWithOrderBy({required String path, required String orderBy}) async {
    return await _firestore.collection(path).where('deleted', isNull: true).orderBy(orderBy).get();
  }

  Stream<QuerySnapshot> streamDataCollection({required String path}) {
    return _firestore.collection(path).snapshots();
  }

  Future<DocumentSnapshot> getDocumentById({required String path, required String id}) async {
    return await _firestore.collection(path).doc(id).get();
  }

  Future<QuerySnapshot> getDocumentsBySearchTerm({required String path, required String field, required String searchTerm, int limit = 5}) async {
    return await _firestore
        .collectionGroup(path)
        .where(field, isGreaterThanOrEqualTo: searchTerm)
        .where(field, isLessThanOrEqualTo: '${searchTerm}z')
        .where('deleted', isNull: true)
        .limit(limit)
        .get();
  }

  Future<QuerySnapshot> getDocumentsBySearchTermWithFilter({required String path, required String field, required String searchTerm, required Filter filter, int limit = 5}) async {
    return await _firestore
        .collectionGroup(path)
        .where(field, isGreaterThanOrEqualTo: searchTerm)
        .where(field, isLessThanOrEqualTo: '${searchTerm}z')
        .where(filter)
        .where('deleted', isNull: true)
        .limit(limit)
        .get();
  }

  Future<QuerySnapshot> getGroupDocumentsByFilter({required String path, required Filter filter, int limit = 5}) async {
    return await _firestore.collectionGroup(path).where(filter).limit(limit).get();
  }

  Future<QuerySnapshot> getDocumentsByFilter({required String path, required Filter filter, int limit = 5}) async {
    return await _firestore.collection(path).where(filter).limit(limit).get();
  }

  Future<QuerySnapshot> getDocumentsByFilterWithOrderBy({required String path, required Filter filter, required String orderBy, int limit = 5}) async {
    return await _firestore.collection(path).where(filter).orderBy(orderBy).limit(limit).get();
  }

  Future<AggregateQuerySnapshot> getDocumentCountByFilter({required String path, required Filter filter}) async {
    return await _firestore.collection(path).where(filter).count().get();
  }

  Future<AggregateQuerySnapshot> getDocumentCountByFilterWithOrderBy({required String path, required Filter filter, required String orderBy}) async {
    return await _firestore.collection(path).where(filter).orderBy(orderBy).count().get();
  }

  Future<void> removeDocument({required String path, required String id}) async {
    await _firestore.collection(path).doc(id).delete();
  }

  Future<DocumentReference> addDocument({required String path, required Map<String, dynamic> data}) async {
    return await _firestore.collection(path).add(data);
  }

  Future<void> updateDocument({required String path, required Map<String, dynamic> data, required String id}) async {
    await _firestore.collection(path).doc(id).update(data);
  }

  Future<void> updateDocumentWithMerge({required String path, required Map<String, dynamic> data, required String id}) async {
    await _firestore.collection(path).doc(id).set(data, SetOptions(merge: true));
  }

  Future<void> setDocument({required String path, required Map<String, dynamic> data, required String id}) async {
    await _firestore.collection(path).doc(id).set(data);
  }
}

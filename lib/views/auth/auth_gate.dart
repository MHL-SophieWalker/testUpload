import 'package:firebase_auth/firebase_auth.dart' hide EmailAuthProvider;
import 'package:flutter/material.dart';
import 'package:hart_suite/models/profile/person.dart';
import 'package:hart_suite/repos/profile/person_repo.dart';
import 'package:hart_suite/views/main/app_introduction.dart';
import 'package:hart_suite/views/auth/login.dart';

import '../main/home.dart';

class AuthGate extends StatefulWidget {
  static const route = '/authGate';

  const AuthGate({super.key});

  @override
  State<AuthGate> createState() => _AuthGateState();
}

class _AuthGateState extends State<AuthGate> {
  late Person? person;
  late Widget page;

  @override
  void initState() {
    super.initState();

    person = null;
    page = Container();
  }

  @override
  Widget build(BuildContext context) {
    return StreamBuilder<User?>(
      stream: FirebaseAuth.instance.authStateChanges(),
      builder: (context, snapshot) {
        if (!snapshot.hasData) {
          return const LoginPage();
        }

        return getPage(callback: () => setState(() => {}), widget: widget);
      },
    );
  }

  Widget getPage({required Function callback, required AuthGate widget}) {
    if (person == null && page is Container) {
      getUser().then((value) {
        person = value;

        if (person == null) {
          page = const AppIntroduction();
        } else {
          page = const HomePage(title: 'HartSuite®');
        }

        callback();
      });
    }

    return page;
  }

  Future<Person?> getUser() async {
    Person? p;

    await PersonRepo().getById(id: FirebaseAuth.instance.currentUser!.uid).then((value) => {p = value});

    return p;
  }
}